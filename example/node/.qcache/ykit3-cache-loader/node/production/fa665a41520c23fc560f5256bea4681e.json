{"remainingRequest":"/Users/Aaron/Desktop/work/qunar/work/ykit3/packages/ykit3-cli/node_modules/babel-loader/lib/index.js??ref--4-2!/Users/Aaron/Desktop/work/qunar/work/sniperjs/example/node/node_modules/history/esm/history.js","dependencies":[{"path":"/Users/Aaron/Desktop/work/qunar/work/sniperjs/example/node/node_modules/history/esm/history.js","hash":"88b53e89d10d17a9de4bd7559151c930"},{"path":"/Users/Aaron/Desktop/work/qunar/work/ykit3/packages/ykit3-cli/node_modules/cache-loader-hash/dist/cjs.js","hash":"d62e2d390167bf8193569f1644327c55"},{"path":"/Users/Aaron/Desktop/work/qunar/work/ykit3/packages/ykit3-cli/node_modules/babel-loader/lib/index.js","hash":"19adf3159c902f1ed7907f3931384270"}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:InVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogIHZhbHVlOiB0cnVlCn0pOwpleHBvcnRzLmNyZWF0ZUJyb3dzZXJIaXN0b3J5ID0gY3JlYXRlQnJvd3Nlckhpc3Rvcnk7CmV4cG9ydHMuY3JlYXRlSGFzaEhpc3RvcnkgPSBjcmVhdGVIYXNoSGlzdG9yeTsKZXhwb3J0cy5jcmVhdGVNZW1vcnlIaXN0b3J5ID0gY3JlYXRlTWVtb3J5SGlzdG9yeTsKZXhwb3J0cy5jcmVhdGVMb2NhdGlvbiA9IGNyZWF0ZUxvY2F0aW9uOwpleHBvcnRzLmxvY2F0aW9uc0FyZUVxdWFsID0gbG9jYXRpb25zQXJlRXF1YWw7CmV4cG9ydHMucGFyc2VQYXRoID0gcGFyc2VQYXRoOwpleHBvcnRzLmNyZWF0ZVBhdGggPSBjcmVhdGVQYXRoOwoKdmFyIF9leHRlbmRzMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9lc20vZXh0ZW5kcyIpKTsKCnZhciBfcmVzb2x2ZVBhdGhuYW1lID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCJyZXNvbHZlLXBhdGhuYW1lIikpOwoKdmFyIF92YWx1ZUVxdWFsID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCJ2YWx1ZS1lcXVhbCIpKTsKCnZhciBfdGlueVdhcm5pbmcgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoInRpbnktd2FybmluZyIpKTsKCnZhciBfdGlueUludmFyaWFudCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgidGlueS1pbnZhcmlhbnQiKSk7CgpmdW5jdGlvbiBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KG9iaikgeyByZXR1cm4gb2JqICYmIG9iai5fX2VzTW9kdWxlID8gb2JqIDogeyBkZWZhdWx0OiBvYmogfTsgfQoKZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgIkBiYWJlbC9oZWxwZXJzIC0gdHlwZW9mIjsgaWYgKHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIpIHsgX3R5cGVvZiA9IGZ1bmN0aW9uIF90eXBlb2Yob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqOyB9OyB9IGVsc2UgeyBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogdHlwZW9mIG9iajsgfTsgfSByZXR1cm4gX3R5cGVvZihvYmopOyB9CgpmdW5jdGlvbiBhZGRMZWFkaW5nU2xhc2gocGF0aCkgewogIHJldHVybiBwYXRoLmNoYXJBdCgwKSA9PT0gJy8nID8gcGF0aCA6ICcvJyArIHBhdGg7Cn0KCmZ1bmN0aW9uIHN0cmlwTGVhZGluZ1NsYXNoKHBhdGgpIHsKICByZXR1cm4gcGF0aC5jaGFyQXQoMCkgPT09ICcvJyA/IHBhdGguc3Vic3RyKDEpIDogcGF0aDsKfQoKZnVuY3Rpb24gaGFzQmFzZW5hbWUocGF0aCwgcHJlZml4KSB7CiAgcmV0dXJuIHBhdGgudG9Mb3dlckNhc2UoKS5pbmRleE9mKHByZWZpeC50b0xvd2VyQ2FzZSgpKSA9PT0gMCAmJiAnLz8jJy5pbmRleE9mKHBhdGguY2hhckF0KHByZWZpeC5sZW5ndGgpKSAhPT0gLTE7Cn0KCmZ1bmN0aW9uIHN0cmlwQmFzZW5hbWUocGF0aCwgcHJlZml4KSB7CiAgcmV0dXJuIGhhc0Jhc2VuYW1lKHBhdGgsIHByZWZpeCkgPyBwYXRoLnN1YnN0cihwcmVmaXgubGVuZ3RoKSA6IHBhdGg7Cn0KCmZ1bmN0aW9uIHN0cmlwVHJhaWxpbmdTbGFzaChwYXRoKSB7CiAgcmV0dXJuIHBhdGguY2hhckF0KHBhdGgubGVuZ3RoIC0gMSkgPT09ICcvJyA/IHBhdGguc2xpY2UoMCwgLTEpIDogcGF0aDsKfQoKZnVuY3Rpb24gcGFyc2VQYXRoKHBhdGgpIHsKICB2YXIgcGF0aG5hbWUgPSBwYXRoIHx8ICcvJzsKICB2YXIgc2VhcmNoID0gJyc7CiAgdmFyIGhhc2ggPSAnJzsKICB2YXIgaGFzaEluZGV4ID0gcGF0aG5hbWUuaW5kZXhPZignIycpOwoKICBpZiAoaGFzaEluZGV4ICE9PSAtMSkgewogICAgaGFzaCA9IHBhdGhuYW1lLnN1YnN0cihoYXNoSW5kZXgpOwogICAgcGF0aG5hbWUgPSBwYXRobmFtZS5zdWJzdHIoMCwgaGFzaEluZGV4KTsKICB9CgogIHZhciBzZWFyY2hJbmRleCA9IHBhdGhuYW1lLmluZGV4T2YoJz8nKTsKCiAgaWYgKHNlYXJjaEluZGV4ICE9PSAtMSkgewogICAgc2VhcmNoID0gcGF0aG5hbWUuc3Vic3RyKHNlYXJjaEluZGV4KTsKICAgIHBhdGhuYW1lID0gcGF0aG5hbWUuc3Vic3RyKDAsIHNlYXJjaEluZGV4KTsKICB9CgogIHJldHVybiB7CiAgICBwYXRobmFtZTogcGF0aG5hbWUsCiAgICBzZWFyY2g6IHNlYXJjaCA9PT0gJz8nID8gJycgOiBzZWFyY2gsCiAgICBoYXNoOiBoYXNoID09PSAnIycgPyAnJyA6IGhhc2gKICB9Owp9CgpmdW5jdGlvbiBjcmVhdGVQYXRoKGxvY2F0aW9uKSB7CiAgdmFyIHBhdGhuYW1lID0gbG9jYXRpb24ucGF0aG5hbWUsCiAgICAgIHNlYXJjaCA9IGxvY2F0aW9uLnNlYXJjaCwKICAgICAgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgdmFyIHBhdGggPSBwYXRobmFtZSB8fCAnLyc7CiAgaWYgKHNlYXJjaCAmJiBzZWFyY2ggIT09ICc/JykgcGF0aCArPSBzZWFyY2guY2hhckF0KDApID09PSAnPycgPyBzZWFyY2ggOiAiPyIgKyBzZWFyY2g7CiAgaWYgKGhhc2ggJiYgaGFzaCAhPT0gJyMnKSBwYXRoICs9IGhhc2guY2hhckF0KDApID09PSAnIycgPyBoYXNoIDogIiMiICsgaGFzaDsKICByZXR1cm4gcGF0aDsKfQoKZnVuY3Rpb24gY3JlYXRlTG9jYXRpb24ocGF0aCwgc3RhdGUsIGtleSwgY3VycmVudExvY2F0aW9uKSB7CiAgdmFyIGxvY2F0aW9uOwoKICBpZiAodHlwZW9mIHBhdGggPT09ICdzdHJpbmcnKSB7CiAgICAvLyBUd28tYXJnIGZvcm06IHB1c2gocGF0aCwgc3RhdGUpCiAgICBsb2NhdGlvbiA9IHBhcnNlUGF0aChwYXRoKTsKICAgIGxvY2F0aW9uLnN0YXRlID0gc3RhdGU7CiAgfSBlbHNlIHsKICAgIC8vIE9uZS1hcmcgZm9ybTogcHVzaChsb2NhdGlvbikKICAgIGxvY2F0aW9uID0gKDAsIF9leHRlbmRzMi5kZWZhdWx0KSh7fSwgcGF0aCk7CiAgICBpZiAobG9jYXRpb24ucGF0aG5hbWUgPT09IHVuZGVmaW5lZCkgbG9jYXRpb24ucGF0aG5hbWUgPSAnJzsKCiAgICBpZiAobG9jYXRpb24uc2VhcmNoKSB7CiAgICAgIGlmIChsb2NhdGlvbi5zZWFyY2guY2hhckF0KDApICE9PSAnPycpIGxvY2F0aW9uLnNlYXJjaCA9ICc/JyArIGxvY2F0aW9uLnNlYXJjaDsKICAgIH0gZWxzZSB7CiAgICAgIGxvY2F0aW9uLnNlYXJjaCA9ICcnOwogICAgfQoKICAgIGlmIChsb2NhdGlvbi5oYXNoKSB7CiAgICAgIGlmIChsb2NhdGlvbi5oYXNoLmNoYXJBdCgwKSAhPT0gJyMnKSBsb2NhdGlvbi5oYXNoID0gJyMnICsgbG9jYXRpb24uaGFzaDsKICAgIH0gZWxzZSB7CiAgICAgIGxvY2F0aW9uLmhhc2ggPSAnJzsKICAgIH0KCiAgICBpZiAoc3RhdGUgIT09IHVuZGVmaW5lZCAmJiBsb2NhdGlvbi5zdGF0ZSA9PT0gdW5kZWZpbmVkKSBsb2NhdGlvbi5zdGF0ZSA9IHN0YXRlOwogIH0KCiAgdHJ5IHsKICAgIGxvY2F0aW9uLnBhdGhuYW1lID0gZGVjb2RlVVJJKGxvY2F0aW9uLnBhdGhuYW1lKTsKICB9IGNhdGNoIChlKSB7CiAgICBpZiAoZSBpbnN0YW5jZW9mIFVSSUVycm9yKSB7CiAgICAgIHRocm93IG5ldyBVUklFcnJvcignUGF0aG5hbWUgIicgKyBsb2NhdGlvbi5wYXRobmFtZSArICciIGNvdWxkIG5vdCBiZSBkZWNvZGVkLiAnICsgJ1RoaXMgaXMgbGlrZWx5IGNhdXNlZCBieSBhbiBpbnZhbGlkIHBlcmNlbnQtZW5jb2RpbmcuJyk7CiAgICB9IGVsc2UgewogICAgICB0aHJvdyBlOwogICAgfQogIH0KCiAgaWYgKGtleSkgbG9jYXRpb24ua2V5ID0ga2V5OwoKICBpZiAoY3VycmVudExvY2F0aW9uKSB7CiAgICAvLyBSZXNvbHZlIGluY29tcGxldGUvcmVsYXRpdmUgcGF0aG5hbWUgcmVsYXRpdmUgdG8gY3VycmVudCBsb2NhdGlvbi4KICAgIGlmICghbG9jYXRpb24ucGF0aG5hbWUpIHsKICAgICAgbG9jYXRpb24ucGF0aG5hbWUgPSBjdXJyZW50TG9jYXRpb24ucGF0aG5hbWU7CiAgICB9IGVsc2UgaWYgKGxvY2F0aW9uLnBhdGhuYW1lLmNoYXJBdCgwKSAhPT0gJy8nKSB7CiAgICAgIGxvY2F0aW9uLnBhdGhuYW1lID0gKDAsIF9yZXNvbHZlUGF0aG5hbWUuZGVmYXVsdCkobG9jYXRpb24ucGF0aG5hbWUsIGN1cnJlbnRMb2NhdGlvbi5wYXRobmFtZSk7CiAgICB9CiAgfSBlbHNlIHsKICAgIC8vIFdoZW4gdGhlcmUgaXMgbm8gcHJpb3IgbG9jYXRpb24gYW5kIHBhdGhuYW1lIGlzIGVtcHR5LCBzZXQgaXQgdG8gLwogICAgaWYgKCFsb2NhdGlvbi5wYXRobmFtZSkgewogICAgICBsb2NhdGlvbi5wYXRobmFtZSA9ICcvJzsKICAgIH0KICB9CgogIHJldHVybiBsb2NhdGlvbjsKfQoKZnVuY3Rpb24gbG9jYXRpb25zQXJlRXF1YWwoYSwgYikgewogIHJldHVybiBhLnBhdGhuYW1lID09PSBiLnBhdGhuYW1lICYmIGEuc2VhcmNoID09PSBiLnNlYXJjaCAmJiBhLmhhc2ggPT09IGIuaGFzaCAmJiBhLmtleSA9PT0gYi5rZXkgJiYgKDAsIF92YWx1ZUVxdWFsLmRlZmF1bHQpKGEuc3RhdGUsIGIuc3RhdGUpOwp9CgpmdW5jdGlvbiBjcmVhdGVUcmFuc2l0aW9uTWFuYWdlcigpIHsKICB2YXIgcHJvbXB0ID0gbnVsbDsKCiAgZnVuY3Rpb24gc2V0UHJvbXB0KG5leHRQcm9tcHQpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAicHJvZHVjdGlvbiIgPyAoMCwgX3RpbnlXYXJuaW5nLmRlZmF1bHQpKHByb21wdCA9PSBudWxsLCAnQSBoaXN0b3J5IHN1cHBvcnRzIG9ubHkgb25lIHByb21wdCBhdCBhIHRpbWUnKSA6IHZvaWQgMDsKICAgIHByb21wdCA9IG5leHRQcm9tcHQ7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBpZiAocHJvbXB0ID09PSBuZXh0UHJvbXB0KSBwcm9tcHQgPSBudWxsOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIGNvbmZpcm1UcmFuc2l0aW9uVG8obG9jYXRpb24sIGFjdGlvbiwgZ2V0VXNlckNvbmZpcm1hdGlvbiwgY2FsbGJhY2spIHsKICAgIC8vIFRPRE86IElmIGFub3RoZXIgdHJhbnNpdGlvbiBzdGFydHMgd2hpbGUgd2UncmUgc3RpbGwgY29uZmlybWluZwogICAgLy8gdGhlIHByZXZpb3VzIG9uZSwgd2UgbWF5IGVuZCB1cCBpbiBhIHdlaXJkIHN0YXRlLiBGaWd1cmUgb3V0IHRoZQogICAgLy8gYmVzdCB3YXkgdG8gaGFuZGxlIHRoaXMuCiAgICBpZiAocHJvbXB0ICE9IG51bGwpIHsKICAgICAgdmFyIHJlc3VsdCA9IHR5cGVvZiBwcm9tcHQgPT09ICdmdW5jdGlvbicgPyBwcm9tcHQobG9jYXRpb24sIGFjdGlvbikgOiBwcm9tcHQ7CgogICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpZiAodHlwZW9mIGdldFVzZXJDb25maXJtYXRpb24gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIGdldFVzZXJDb25maXJtYXRpb24ocmVzdWx0LCBjYWxsYmFjayk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAicHJvZHVjdGlvbiIgPyAoMCwgX3RpbnlXYXJuaW5nLmRlZmF1bHQpKGZhbHNlLCAnQSBoaXN0b3J5IG5lZWRzIGEgZ2V0VXNlckNvbmZpcm1hdGlvbiBmdW5jdGlvbiBpbiBvcmRlciB0byB1c2UgYSBwcm9tcHQgbWVzc2FnZScpIDogdm9pZCAwOwogICAgICAgICAgY2FsbGJhY2sodHJ1ZSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIFJldHVybiBmYWxzZSBmcm9tIGEgdHJhbnNpdGlvbiBob29rIHRvIGNhbmNlbCB0aGUgdHJhbnNpdGlvbi4KICAgICAgICBjYWxsYmFjayhyZXN1bHQgIT09IGZhbHNlKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2sodHJ1ZSk7CiAgICB9CiAgfQoKICB2YXIgbGlzdGVuZXJzID0gW107CgogIGZ1bmN0aW9uIGFwcGVuZExpc3RlbmVyKGZuKSB7CiAgICB2YXIgaXNBY3RpdmUgPSB0cnVlOwoKICAgIGZ1bmN0aW9uIGxpc3RlbmVyKCkgewogICAgICBpZiAoaXNBY3RpdmUpIGZuLmFwcGx5KHZvaWQgMCwgYXJndW1lbnRzKTsKICAgIH0KCiAgICBsaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICBpc0FjdGl2ZSA9IGZhbHNlOwogICAgICBsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMuZmlsdGVyKGZ1bmN0aW9uIChpdGVtKSB7CiAgICAgICAgcmV0dXJuIGl0ZW0gIT09IGxpc3RlbmVyOwogICAgICB9KTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBub3RpZnlMaXN0ZW5lcnMoKSB7CiAgICBmb3IgKHZhciBfbGVuID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuKSwgX2tleSA9IDA7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHsKICAgICAgYXJnc1tfa2V5XSA9IGFyZ3VtZW50c1tfa2V5XTsKICAgIH0KCiAgICBsaXN0ZW5lcnMuZm9yRWFjaChmdW5jdGlvbiAobGlzdGVuZXIpIHsKICAgICAgcmV0dXJuIGxpc3RlbmVyLmFwcGx5KHZvaWQgMCwgYXJncyk7CiAgICB9KTsKICB9CgogIHJldHVybiB7CiAgICBzZXRQcm9tcHQ6IHNldFByb21wdCwKICAgIGNvbmZpcm1UcmFuc2l0aW9uVG86IGNvbmZpcm1UcmFuc2l0aW9uVG8sCiAgICBhcHBlbmRMaXN0ZW5lcjogYXBwZW5kTGlzdGVuZXIsCiAgICBub3RpZnlMaXN0ZW5lcnM6IG5vdGlmeUxpc3RlbmVycwogIH07Cn0KCnZhciBjYW5Vc2VET00gPSAhISh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuZG9jdW1lbnQgJiYgd2luZG93LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQpOwoKZnVuY3Rpb24gZ2V0Q29uZmlybWF0aW9uKG1lc3NhZ2UsIGNhbGxiYWNrKSB7CiAgY2FsbGJhY2sod2luZG93LmNvbmZpcm0obWVzc2FnZSkpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWFsZXJ0Cn0KLyoqCiAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgSFRNTDUgaGlzdG9yeSBBUEkgaXMgc3VwcG9ydGVkLiBUYWtlbiBmcm9tIE1vZGVybml6ci4KICoKICogaHR0cHM6Ly9naXRodWIuY29tL01vZGVybml6ci9Nb2Rlcm5penIvYmxvYi9tYXN0ZXIvTElDRU5TRQogKiBodHRwczovL2dpdGh1Yi5jb20vTW9kZXJuaXpyL01vZGVybml6ci9ibG9iL21hc3Rlci9mZWF0dXJlLWRldGVjdHMvaGlzdG9yeS5qcwogKiBjaGFuZ2VkIHRvIGF2b2lkIGZhbHNlIG5lZ2F0aXZlcyBmb3IgV2luZG93cyBQaG9uZXM6IGh0dHBzOi8vZ2l0aHViLmNvbS9yZWFjdGpzL3JlYWN0LXJvdXRlci9pc3N1ZXMvNTg2CiAqLwoKCmZ1bmN0aW9uIHN1cHBvcnRzSGlzdG9yeSgpIHsKICB2YXIgdWEgPSB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudDsKICBpZiAoKHVhLmluZGV4T2YoJ0FuZHJvaWQgMi4nKSAhPT0gLTEgfHwgdWEuaW5kZXhPZignQW5kcm9pZCA0LjAnKSAhPT0gLTEpICYmIHVhLmluZGV4T2YoJ01vYmlsZSBTYWZhcmknKSAhPT0gLTEgJiYgdWEuaW5kZXhPZignQ2hyb21lJykgPT09IC0xICYmIHVhLmluZGV4T2YoJ1dpbmRvd3MgUGhvbmUnKSA9PT0gLTEpIHJldHVybiBmYWxzZTsKICByZXR1cm4gd2luZG93Lmhpc3RvcnkgJiYgJ3B1c2hTdGF0ZScgaW4gd2luZG93Lmhpc3Rvcnk7Cn0KLyoqCiAqIFJldHVybnMgdHJ1ZSBpZiBicm93c2VyIGZpcmVzIHBvcHN0YXRlIG9uIGhhc2ggY2hhbmdlLgogKiBJRTEwIGFuZCBJRTExIGRvIG5vdC4KICovCgoKZnVuY3Rpb24gc3VwcG9ydHNQb3BTdGF0ZU9uSGFzaENoYW5nZSgpIHsKICByZXR1cm4gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignVHJpZGVudCcpID09PSAtMTsKfQovKioKICogUmV0dXJucyBmYWxzZSBpZiB1c2luZyBnbyhuKSB3aXRoIGhhc2ggaGlzdG9yeSBjYXVzZXMgYSBmdWxsIHBhZ2UgcmVsb2FkLgogKi8KCgpmdW5jdGlvbiBzdXBwb3J0c0dvV2l0aG91dFJlbG9hZFVzaW5nSGFzaCgpIHsKICByZXR1cm4gd2luZG93Lm5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignRmlyZWZveCcpID09PSAtMTsKfQovKioKICogUmV0dXJucyB0cnVlIGlmIGEgZ2l2ZW4gcG9wc3RhdGUgZXZlbnQgaXMgYW4gZXh0cmFuZW91cyBXZWJLaXQgZXZlbnQuCiAqIEFjY291bnRzIGZvciB0aGUgZmFjdCB0aGF0IENocm9tZSBvbiBpT1MgZmlyZXMgcmVhbCBwb3BzdGF0ZSBldmVudHMKICogY29udGFpbmluZyB1bmRlZmluZWQgc3RhdGUgd2hlbiBwcmVzc2luZyB0aGUgYmFjayBidXR0b24uCiAqLwoKCmZ1bmN0aW9uIGlzRXh0cmFuZW91c1BvcHN0YXRlRXZlbnQoZXZlbnQpIHsKICByZXR1cm4gZXZlbnQuc3RhdGUgPT09IHVuZGVmaW5lZCAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ0NyaU9TJykgPT09IC0xOwp9Cgp2YXIgUG9wU3RhdGVFdmVudCA9ICdwb3BzdGF0ZSc7CnZhciBIYXNoQ2hhbmdlRXZlbnQgPSAnaGFzaGNoYW5nZSc7CgpmdW5jdGlvbiBnZXRIaXN0b3J5U3RhdGUoKSB7CiAgdHJ5IHsKICAgIHJldHVybiB3aW5kb3cuaGlzdG9yeS5zdGF0ZSB8fCB7fTsKICB9IGNhdGNoIChlKSB7CiAgICAvLyBJRSAxMSBzb21ldGltZXMgdGhyb3dzIHdoZW4gYWNjZXNzaW5nIHdpbmRvdy5oaXN0b3J5LnN0YXRlCiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL1JlYWN0VHJhaW5pbmcvaGlzdG9yeS9wdWxsLzI4OQogICAgcmV0dXJuIHt9OwogIH0KfQovKioKICogQ3JlYXRlcyBhIGhpc3Rvcnkgb2JqZWN0IHRoYXQgdXNlcyB0aGUgSFRNTDUgaGlzdG9yeSBBUEkgaW5jbHVkaW5nCiAqIHB1c2hTdGF0ZSwgcmVwbGFjZVN0YXRlLCBhbmQgdGhlIHBvcHN0YXRlIGV2ZW50LgogKi8KCgpmdW5jdGlvbiBjcmVhdGVCcm93c2VySGlzdG9yeShwcm9wcykgewogIGlmIChwcm9wcyA9PT0gdm9pZCAwKSB7CiAgICBwcm9wcyA9IHt9OwogIH0KCiAgIWNhblVzZURPTSA/IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAicHJvZHVjdGlvbiIgPyAoMCwgX3RpbnlJbnZhcmlhbnQuZGVmYXVsdCkoZmFsc2UsICdCcm93c2VyIGhpc3RvcnkgbmVlZHMgYSBET00nKSA6ICgwLCBfdGlueUludmFyaWFudC5kZWZhdWx0KShmYWxzZSkgOiB2b2lkIDA7CiAgdmFyIGdsb2JhbEhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKICB2YXIgY2FuVXNlSGlzdG9yeSA9IHN1cHBvcnRzSGlzdG9yeSgpOwogIHZhciBuZWVkc0hhc2hDaGFuZ2VMaXN0ZW5lciA9ICFzdXBwb3J0c1BvcFN0YXRlT25IYXNoQ2hhbmdlKCk7CiAgdmFyIF9wcm9wcyA9IHByb3BzLAogICAgICBfcHJvcHMkZm9yY2VSZWZyZXNoID0gX3Byb3BzLmZvcmNlUmVmcmVzaCwKICAgICAgZm9yY2VSZWZyZXNoID0gX3Byb3BzJGZvcmNlUmVmcmVzaCA9PT0gdm9pZCAwID8gZmFsc2UgOiBfcHJvcHMkZm9yY2VSZWZyZXNoLAogICAgICBfcHJvcHMkZ2V0VXNlckNvbmZpcm0gPSBfcHJvcHMuZ2V0VXNlckNvbmZpcm1hdGlvbiwKICAgICAgZ2V0VXNlckNvbmZpcm1hdGlvbiA9IF9wcm9wcyRnZXRVc2VyQ29uZmlybSA9PT0gdm9pZCAwID8gZ2V0Q29uZmlybWF0aW9uIDogX3Byb3BzJGdldFVzZXJDb25maXJtLAogICAgICBfcHJvcHMka2V5TGVuZ3RoID0gX3Byb3BzLmtleUxlbmd0aCwKICAgICAga2V5TGVuZ3RoID0gX3Byb3BzJGtleUxlbmd0aCA9PT0gdm9pZCAwID8gNiA6IF9wcm9wcyRrZXlMZW5ndGg7CiAgdmFyIGJhc2VuYW1lID0gcHJvcHMuYmFzZW5hbWUgPyBzdHJpcFRyYWlsaW5nU2xhc2goYWRkTGVhZGluZ1NsYXNoKHByb3BzLmJhc2VuYW1lKSkgOiAnJzsKCiAgZnVuY3Rpb24gZ2V0RE9NTG9jYXRpb24oaGlzdG9yeVN0YXRlKSB7CiAgICB2YXIgX3JlZiA9IGhpc3RvcnlTdGF0ZSB8fCB7fSwKICAgICAgICBrZXkgPSBfcmVmLmtleSwKICAgICAgICBzdGF0ZSA9IF9yZWYuc3RhdGU7CgogICAgdmFyIF93aW5kb3ckbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCiAgICAgICAgcGF0aG5hbWUgPSBfd2luZG93JGxvY2F0aW9uLnBhdGhuYW1lLAogICAgICAgIHNlYXJjaCA9IF93aW5kb3ckbG9jYXRpb24uc2VhcmNoLAogICAgICAgIGhhc2ggPSBfd2luZG93JGxvY2F0aW9uLmhhc2g7CiAgICB2YXIgcGF0aCA9IHBhdGhuYW1lICsgc2VhcmNoICsgaGFzaDsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAicHJvZHVjdGlvbiIgPyAoMCwgX3RpbnlXYXJuaW5nLmRlZmF1bHQpKCFiYXNlbmFtZSB8fCBoYXNCYXNlbmFtZShwYXRoLCBiYXNlbmFtZSksICdZb3UgYXJlIGF0dGVtcHRpbmcgdG8gdXNlIGEgYmFzZW5hbWUgb24gYSBwYWdlIHdob3NlIFVSTCBwYXRoIGRvZXMgbm90IGJlZ2luICcgKyAnd2l0aCB0aGUgYmFzZW5hbWUuIEV4cGVjdGVkIHBhdGggIicgKyBwYXRoICsgJyIgdG8gYmVnaW4gd2l0aCAiJyArIGJhc2VuYW1lICsgJyIuJykgOiB2b2lkIDA7CiAgICBpZiAoYmFzZW5hbWUpIHBhdGggPSBzdHJpcEJhc2VuYW1lKHBhdGgsIGJhc2VuYW1lKTsKICAgIHJldHVybiBjcmVhdGVMb2NhdGlvbihwYXRoLCBzdGF0ZSwga2V5KTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUtleSgpIHsKICAgIHJldHVybiBNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwga2V5TGVuZ3RoKTsKICB9CgogIHZhciB0cmFuc2l0aW9uTWFuYWdlciA9IGNyZWF0ZVRyYW5zaXRpb25NYW5hZ2VyKCk7CgogIGZ1bmN0aW9uIHNldFN0YXRlKG5leHRTdGF0ZSkgewogICAgKDAsIF9leHRlbmRzMi5kZWZhdWx0KShoaXN0b3J5LCBuZXh0U3RhdGUpOwogICAgaGlzdG9yeS5sZW5ndGggPSBnbG9iYWxIaXN0b3J5Lmxlbmd0aDsKICAgIHRyYW5zaXRpb25NYW5hZ2VyLm5vdGlmeUxpc3RlbmVycyhoaXN0b3J5LmxvY2F0aW9uLCBoaXN0b3J5LmFjdGlvbik7CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVQb3BTdGF0ZShldmVudCkgewogICAgLy8gSWdub3JlIGV4dHJhbmVvdXMgcG9wc3RhdGUgZXZlbnRzIGluIFdlYktpdC4KICAgIGlmIChpc0V4dHJhbmVvdXNQb3BzdGF0ZUV2ZW50KGV2ZW50KSkgcmV0dXJuOwogICAgaGFuZGxlUG9wKGdldERPTUxvY2F0aW9uKGV2ZW50LnN0YXRlKSk7CiAgfQoKICBmdW5jdGlvbiBoYW5kbGVIYXNoQ2hhbmdlKCkgewogICAgaGFuZGxlUG9wKGdldERPTUxvY2F0aW9uKGdldEhpc3RvcnlTdGF0ZSgpKSk7CiAgfQoKICB2YXIgZm9yY2VOZXh0UG9wID0gZmFsc2U7CgogIGZ1bmN0aW9uIGhhbmRsZVBvcChsb2NhdGlvbikgewogICAgaWYgKGZvcmNlTmV4dFBvcCkgewogICAgICBmb3JjZU5leHRQb3AgPSBmYWxzZTsKICAgICAgc2V0U3RhdGUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBhY3Rpb24gPSAnUE9QJzsKICAgICAgdHJhbnNpdGlvbk1hbmFnZXIuY29uZmlybVRyYW5zaXRpb25Ubyhsb2NhdGlvbiwgYWN0aW9uLCBnZXRVc2VyQ29uZmlybWF0aW9uLCBmdW5jdGlvbiAob2spIHsKICAgICAgICBpZiAob2spIHsKICAgICAgICAgIHNldFN0YXRlKHsKICAgICAgICAgICAgYWN0aW9uOiBhY3Rpb24sCiAgICAgICAgICAgIGxvY2F0aW9uOiBsb2NhdGlvbgogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldmVydFBvcChsb2NhdGlvbik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJldmVydFBvcChmcm9tTG9jYXRpb24pIHsKICAgIHZhciB0b0xvY2F0aW9uID0gaGlzdG9yeS5sb2NhdGlvbjsgLy8gVE9ETzogV2UgY291bGQgcHJvYmFibHkgbWFrZSB0aGlzIG1vcmUgcmVsaWFibGUgYnkKICAgIC8vIGtlZXBpbmcgYSBsaXN0IG9mIGtleXMgd2UndmUgc2VlbiBpbiBzZXNzaW9uU3RvcmFnZS4KICAgIC8vIEluc3RlYWQsIHdlIGp1c3QgZGVmYXVsdCB0byAwIGZvciBrZXlzIHdlIGRvbid0IGtub3cuCgogICAgdmFyIHRvSW5kZXggPSBhbGxLZXlzLmluZGV4T2YodG9Mb2NhdGlvbi5rZXkpOwogICAgaWYgKHRvSW5kZXggPT09IC0xKSB0b0luZGV4ID0gMDsKICAgIHZhciBmcm9tSW5kZXggPSBhbGxLZXlzLmluZGV4T2YoZnJvbUxvY2F0aW9uLmtleSk7CiAgICBpZiAoZnJvbUluZGV4ID09PSAtMSkgZnJvbUluZGV4ID0gMDsKICAgIHZhciBkZWx0YSA9IHRvSW5kZXggLSBmcm9tSW5kZXg7CgogICAgaWYgKGRlbHRhKSB7CiAgICAgIGZvcmNlTmV4dFBvcCA9IHRydWU7CiAgICAgIGdvKGRlbHRhKTsKICAgIH0KICB9CgogIHZhciBpbml0aWFsTG9jYXRpb24gPSBnZXRET01Mb2NhdGlvbihnZXRIaXN0b3J5U3RhdGUoKSk7CiAgdmFyIGFsbEtleXMgPSBbaW5pdGlhbExvY2F0aW9uLmtleV07IC8vIFB1YmxpYyBpbnRlcmZhY2UKCiAgZnVuY3Rpb24gY3JlYXRlSHJlZihsb2NhdGlvbikgewogICAgcmV0dXJuIGJhc2VuYW1lICsgY3JlYXRlUGF0aChsb2NhdGlvbik7CiAgfQoKICBmdW5jdGlvbiBwdXNoKHBhdGgsIHN0YXRlKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gInByb2R1Y3Rpb24iID8gKDAsIF90aW55V2FybmluZy5kZWZhdWx0KSghKF90eXBlb2YocGF0aCkgPT09ICdvYmplY3QnICYmIHBhdGguc3RhdGUgIT09IHVuZGVmaW5lZCAmJiBzdGF0ZSAhPT0gdW5kZWZpbmVkKSwgJ1lvdSBzaG91bGQgYXZvaWQgcHJvdmlkaW5nIGEgMm5kIHN0YXRlIGFyZ3VtZW50IHRvIHB1c2ggd2hlbiB0aGUgMXN0ICcgKyAnYXJndW1lbnQgaXMgYSBsb2NhdGlvbi1saWtlIG9iamVjdCB0aGF0IGFscmVhZHkgaGFzIHN0YXRlOyBpdCBpcyBpZ25vcmVkJykgOiB2b2lkIDA7CiAgICB2YXIgYWN0aW9uID0gJ1BVU0gnOwogICAgdmFyIGxvY2F0aW9uID0gY3JlYXRlTG9jYXRpb24ocGF0aCwgc3RhdGUsIGNyZWF0ZUtleSgpLCBoaXN0b3J5LmxvY2F0aW9uKTsKICAgIHRyYW5zaXRpb25NYW5hZ2VyLmNvbmZpcm1UcmFuc2l0aW9uVG8obG9jYXRpb24sIGFjdGlvbiwgZ2V0VXNlckNvbmZpcm1hdGlvbiwgZnVuY3Rpb24gKG9rKSB7CiAgICAgIGlmICghb2spIHJldHVybjsKICAgICAgdmFyIGhyZWYgPSBjcmVhdGVIcmVmKGxvY2F0aW9uKTsKICAgICAgdmFyIGtleSA9IGxvY2F0aW9uLmtleSwKICAgICAgICAgIHN0YXRlID0gbG9jYXRpb24uc3RhdGU7CgogICAgICBpZiAoY2FuVXNlSGlzdG9yeSkgewogICAgICAgIGdsb2JhbEhpc3RvcnkucHVzaFN0YXRlKHsKICAgICAgICAgIGtleToga2V5LAogICAgICAgICAgc3RhdGU6IHN0YXRlCiAgICAgICAgfSwgbnVsbCwgaHJlZik7CgogICAgICAgIGlmIChmb3JjZVJlZnJlc2gpIHsKICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gaHJlZjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHByZXZJbmRleCA9IGFsbEtleXMuaW5kZXhPZihoaXN0b3J5LmxvY2F0aW9uLmtleSk7CiAgICAgICAgICB2YXIgbmV4dEtleXMgPSBhbGxLZXlzLnNsaWNlKDAsIHByZXZJbmRleCArIDEpOwogICAgICAgICAgbmV4dEtleXMucHVzaChsb2NhdGlvbi5rZXkpOwogICAgICAgICAgYWxsS2V5cyA9IG5leHRLZXlzOwogICAgICAgICAgc2V0U3RhdGUoewogICAgICAgICAgICBhY3Rpb246IGFjdGlvbiwKICAgICAgICAgICAgbG9jYXRpb246IGxvY2F0aW9uCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICJwcm9kdWN0aW9uIiA/ICgwLCBfdGlueVdhcm5pbmcuZGVmYXVsdCkoc3RhdGUgPT09IHVuZGVmaW5lZCwgJ0Jyb3dzZXIgaGlzdG9yeSBjYW5ub3QgcHVzaCBzdGF0ZSBpbiBicm93c2VycyB0aGF0IGRvIG5vdCBzdXBwb3J0IEhUTUw1IGhpc3RvcnknKSA6IHZvaWQgMDsKICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IGhyZWY7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gcmVwbGFjZShwYXRoLCBzdGF0ZSkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICJwcm9kdWN0aW9uIiA/ICgwLCBfdGlueVdhcm5pbmcuZGVmYXVsdCkoIShfdHlwZW9mKHBhdGgpID09PSAnb2JqZWN0JyAmJiBwYXRoLnN0YXRlICE9PSB1bmRlZmluZWQgJiYgc3RhdGUgIT09IHVuZGVmaW5lZCksICdZb3Ugc2hvdWxkIGF2b2lkIHByb3ZpZGluZyBhIDJuZCBzdGF0ZSBhcmd1bWVudCB0byByZXBsYWNlIHdoZW4gdGhlIDFzdCAnICsgJ2FyZ3VtZW50IGlzIGEgbG9jYXRpb24tbGlrZSBvYmplY3QgdGhhdCBhbHJlYWR5IGhhcyBzdGF0ZTsgaXQgaXMgaWdub3JlZCcpIDogdm9pZCAwOwogICAgdmFyIGFjdGlvbiA9ICdSRVBMQUNFJzsKICAgIHZhciBsb2NhdGlvbiA9IGNyZWF0ZUxvY2F0aW9uKHBhdGgsIHN0YXRlLCBjcmVhdGVLZXkoKSwgaGlzdG9yeS5sb2NhdGlvbik7CiAgICB0cmFuc2l0aW9uTWFuYWdlci5jb25maXJtVHJhbnNpdGlvblRvKGxvY2F0aW9uLCBhY3Rpb24sIGdldFVzZXJDb25maXJtYXRpb24sIGZ1bmN0aW9uIChvaykgewogICAgICBpZiAoIW9rKSByZXR1cm47CiAgICAgIHZhciBocmVmID0gY3JlYXRlSHJlZihsb2NhdGlvbik7CiAgICAgIHZhciBrZXkgPSBsb2NhdGlvbi5rZXksCiAgICAgICAgICBzdGF0ZSA9IGxvY2F0aW9uLnN0YXRlOwoKICAgICAgaWYgKGNhblVzZUhpc3RvcnkpIHsKICAgICAgICBnbG9iYWxIaXN0b3J5LnJlcGxhY2VTdGF0ZSh7CiAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgIHN0YXRlOiBzdGF0ZQogICAgICAgIH0sIG51bGwsIGhyZWYpOwoKICAgICAgICBpZiAoZm9yY2VSZWZyZXNoKSB7CiAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVwbGFjZShocmVmKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHByZXZJbmRleCA9IGFsbEtleXMuaW5kZXhPZihoaXN0b3J5LmxvY2F0aW9uLmtleSk7CiAgICAgICAgICBpZiAocHJldkluZGV4ICE9PSAtMSkgYWxsS2V5c1twcmV2SW5kZXhdID0gbG9jYXRpb24ua2V5OwogICAgICAgICAgc2V0U3RhdGUoewogICAgICAgICAgICBhY3Rpb246IGFjdGlvbiwKICAgICAgICAgICAgbG9jYXRpb246IGxvY2F0aW9uCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICJwcm9kdWN0aW9uIiA/ICgwLCBfdGlueVdhcm5pbmcuZGVmYXVsdCkoc3RhdGUgPT09IHVuZGVmaW5lZCwgJ0Jyb3dzZXIgaGlzdG9yeSBjYW5ub3QgcmVwbGFjZSBzdGF0ZSBpbiBicm93c2VycyB0aGF0IGRvIG5vdCBzdXBwb3J0IEhUTUw1IGhpc3RvcnknKSA6IHZvaWQgMDsKICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVwbGFjZShocmVmKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBnbyhuKSB7CiAgICBnbG9iYWxIaXN0b3J5LmdvKG4pOwogIH0KCiAgZnVuY3Rpb24gZ29CYWNrKCkgewogICAgZ28oLTEpOwogIH0KCiAgZnVuY3Rpb24gZ29Gb3J3YXJkKCkgewogICAgZ28oMSk7CiAgfQoKICB2YXIgbGlzdGVuZXJDb3VudCA9IDA7CgogIGZ1bmN0aW9uIGNoZWNrRE9NTGlzdGVuZXJzKGRlbHRhKSB7CiAgICBsaXN0ZW5lckNvdW50ICs9IGRlbHRhOwoKICAgIGlmIChsaXN0ZW5lckNvdW50ID09PSAxICYmIGRlbHRhID09PSAxKSB7CiAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFBvcFN0YXRlRXZlbnQsIGhhbmRsZVBvcFN0YXRlKTsKICAgICAgaWYgKG5lZWRzSGFzaENoYW5nZUxpc3RlbmVyKSB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihIYXNoQ2hhbmdlRXZlbnQsIGhhbmRsZUhhc2hDaGFuZ2UpOwogICAgfSBlbHNlIGlmIChsaXN0ZW5lckNvdW50ID09PSAwKSB7CiAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKFBvcFN0YXRlRXZlbnQsIGhhbmRsZVBvcFN0YXRlKTsKICAgICAgaWYgKG5lZWRzSGFzaENoYW5nZUxpc3RlbmVyKSB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcihIYXNoQ2hhbmdlRXZlbnQsIGhhbmRsZUhhc2hDaGFuZ2UpOwogICAgfQogIH0KCiAgdmFyIGlzQmxvY2tlZCA9IGZhbHNlOwoKICBmdW5jdGlvbiBibG9jayhwcm9tcHQpIHsKICAgIGlmIChwcm9tcHQgPT09IHZvaWQgMCkgewogICAgICBwcm9tcHQgPSBmYWxzZTsKICAgIH0KCiAgICB2YXIgdW5ibG9jayA9IHRyYW5zaXRpb25NYW5hZ2VyLnNldFByb21wdChwcm9tcHQpOwoKICAgIGlmICghaXNCbG9ja2VkKSB7CiAgICAgIGNoZWNrRE9NTGlzdGVuZXJzKDEpOwogICAgICBpc0Jsb2NrZWQgPSB0cnVlOwogICAgfQoKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChpc0Jsb2NrZWQpIHsKICAgICAgICBpc0Jsb2NrZWQgPSBmYWxzZTsKICAgICAgICBjaGVja0RPTUxpc3RlbmVycygtMSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB1bmJsb2NrKCk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gbGlzdGVuKGxpc3RlbmVyKSB7CiAgICB2YXIgdW5saXN0ZW4gPSB0cmFuc2l0aW9uTWFuYWdlci5hcHBlbmRMaXN0ZW5lcihsaXN0ZW5lcik7CiAgICBjaGVja0RPTUxpc3RlbmVycygxKTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGNoZWNrRE9NTGlzdGVuZXJzKC0xKTsKICAgICAgdW5saXN0ZW4oKTsKICAgIH07CiAgfQoKICB2YXIgaGlzdG9yeSA9IHsKICAgIGxlbmd0aDogZ2xvYmFsSGlzdG9yeS5sZW5ndGgsCiAgICBhY3Rpb246ICdQT1AnLAogICAgbG9jYXRpb246IGluaXRpYWxMb2NhdGlvbiwKICAgIGNyZWF0ZUhyZWY6IGNyZWF0ZUhyZWYsCiAgICBwdXNoOiBwdXNoLAogICAgcmVwbGFjZTogcmVwbGFjZSwKICAgIGdvOiBnbywKICAgIGdvQmFjazogZ29CYWNrLAogICAgZ29Gb3J3YXJkOiBnb0ZvcndhcmQsCiAgICBibG9jazogYmxvY2ssCiAgICBsaXN0ZW46IGxpc3RlbgogIH07CiAgcmV0dXJuIGhpc3Rvcnk7Cn0KCnZhciBIYXNoQ2hhbmdlRXZlbnQkMSA9ICdoYXNoY2hhbmdlJzsKdmFyIEhhc2hQYXRoQ29kZXJzID0gewogIGhhc2hiYW5nOiB7CiAgICBlbmNvZGVQYXRoOiBmdW5jdGlvbiBlbmNvZGVQYXRoKHBhdGgpIHsKICAgICAgcmV0dXJuIHBhdGguY2hhckF0KDApID09PSAnIScgPyBwYXRoIDogJyEvJyArIHN0cmlwTGVhZGluZ1NsYXNoKHBhdGgpOwogICAgfSwKICAgIGRlY29kZVBhdGg6IGZ1bmN0aW9uIGRlY29kZVBhdGgocGF0aCkgewogICAgICByZXR1cm4gcGF0aC5jaGFyQXQoMCkgPT09ICchJyA/IHBhdGguc3Vic3RyKDEpIDogcGF0aDsKICAgIH0KICB9LAogIG5vc2xhc2g6IHsKICAgIGVuY29kZVBhdGg6IHN0cmlwTGVhZGluZ1NsYXNoLAogICAgZGVjb2RlUGF0aDogYWRkTGVhZGluZ1NsYXNoCiAgfSwKICBzbGFzaDogewogICAgZW5jb2RlUGF0aDogYWRkTGVhZGluZ1NsYXNoLAogICAgZGVjb2RlUGF0aDogYWRkTGVhZGluZ1NsYXNoCiAgfQp9OwoKZnVuY3Rpb24gc3RyaXBIYXNoKHVybCkgewogIHZhciBoYXNoSW5kZXggPSB1cmwuaW5kZXhPZignIycpOwogIHJldHVybiBoYXNoSW5kZXggPT09IC0xID8gdXJsIDogdXJsLnNsaWNlKDAsIGhhc2hJbmRleCk7Cn0KCmZ1bmN0aW9uIGdldEhhc2hQYXRoKCkgewogIC8vIFdlIGNhbid0IHVzZSB3aW5kb3cubG9jYXRpb24uaGFzaCBoZXJlIGJlY2F1c2UgaXQncyBub3QKICAvLyBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycyAtIEZpcmVmb3ggd2lsbCBwcmUtZGVjb2RlIGl0IQogIHZhciBocmVmID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CiAgdmFyIGhhc2hJbmRleCA9IGhyZWYuaW5kZXhPZignIycpOwogIHJldHVybiBoYXNoSW5kZXggPT09IC0xID8gJycgOiBocmVmLnN1YnN0cmluZyhoYXNoSW5kZXggKyAxKTsKfQoKZnVuY3Rpb24gcHVzaEhhc2hQYXRoKHBhdGgpIHsKICB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHBhdGg7Cn0KCmZ1bmN0aW9uIHJlcGxhY2VIYXNoUGF0aChwYXRoKSB7CiAgd2luZG93LmxvY2F0aW9uLnJlcGxhY2Uoc3RyaXBIYXNoKHdpbmRvdy5sb2NhdGlvbi5ocmVmKSArICcjJyArIHBhdGgpOwp9CgpmdW5jdGlvbiBjcmVhdGVIYXNoSGlzdG9yeShwcm9wcykgewogIGlmIChwcm9wcyA9PT0gdm9pZCAwKSB7CiAgICBwcm9wcyA9IHt9OwogIH0KCiAgIWNhblVzZURPTSA/IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAicHJvZHVjdGlvbiIgPyAoMCwgX3RpbnlJbnZhcmlhbnQuZGVmYXVsdCkoZmFsc2UsICdIYXNoIGhpc3RvcnkgbmVlZHMgYSBET00nKSA6ICgwLCBfdGlueUludmFyaWFudC5kZWZhdWx0KShmYWxzZSkgOiB2b2lkIDA7CiAgdmFyIGdsb2JhbEhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsKICB2YXIgY2FuR29XaXRob3V0UmVsb2FkID0gc3VwcG9ydHNHb1dpdGhvdXRSZWxvYWRVc2luZ0hhc2goKTsKICB2YXIgX3Byb3BzID0gcHJvcHMsCiAgICAgIF9wcm9wcyRnZXRVc2VyQ29uZmlybSA9IF9wcm9wcy5nZXRVc2VyQ29uZmlybWF0aW9uLAogICAgICBnZXRVc2VyQ29uZmlybWF0aW9uID0gX3Byb3BzJGdldFVzZXJDb25maXJtID09PSB2b2lkIDAgPyBnZXRDb25maXJtYXRpb24gOiBfcHJvcHMkZ2V0VXNlckNvbmZpcm0sCiAgICAgIF9wcm9wcyRoYXNoVHlwZSA9IF9wcm9wcy5oYXNoVHlwZSwKICAgICAgaGFzaFR5cGUgPSBfcHJvcHMkaGFzaFR5cGUgPT09IHZvaWQgMCA/ICdzbGFzaCcgOiBfcHJvcHMkaGFzaFR5cGU7CiAgdmFyIGJhc2VuYW1lID0gcHJvcHMuYmFzZW5hbWUgPyBzdHJpcFRyYWlsaW5nU2xhc2goYWRkTGVhZGluZ1NsYXNoKHByb3BzLmJhc2VuYW1lKSkgOiAnJzsKICB2YXIgX0hhc2hQYXRoQ29kZXJzJGhhc2hUID0gSGFzaFBhdGhDb2RlcnNbaGFzaFR5cGVdLAogICAgICBlbmNvZGVQYXRoID0gX0hhc2hQYXRoQ29kZXJzJGhhc2hULmVuY29kZVBhdGgsCiAgICAgIGRlY29kZVBhdGggPSBfSGFzaFBhdGhDb2RlcnMkaGFzaFQuZGVjb2RlUGF0aDsKCiAgZnVuY3Rpb24gZ2V0RE9NTG9jYXRpb24oKSB7CiAgICB2YXIgcGF0aCA9IGRlY29kZVBhdGgoZ2V0SGFzaFBhdGgoKSk7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gInByb2R1Y3Rpb24iID8gKDAsIF90aW55V2FybmluZy5kZWZhdWx0KSghYmFzZW5hbWUgfHwgaGFzQmFzZW5hbWUocGF0aCwgYmFzZW5hbWUpLCAnWW91IGFyZSBhdHRlbXB0aW5nIHRvIHVzZSBhIGJhc2VuYW1lIG9uIGEgcGFnZSB3aG9zZSBVUkwgcGF0aCBkb2VzIG5vdCBiZWdpbiAnICsgJ3dpdGggdGhlIGJhc2VuYW1lLiBFeHBlY3RlZCBwYXRoICInICsgcGF0aCArICciIHRvIGJlZ2luIHdpdGggIicgKyBiYXNlbmFtZSArICciLicpIDogdm9pZCAwOwogICAgaWYgKGJhc2VuYW1lKSBwYXRoID0gc3RyaXBCYXNlbmFtZShwYXRoLCBiYXNlbmFtZSk7CiAgICByZXR1cm4gY3JlYXRlTG9jYXRpb24ocGF0aCk7CiAgfQoKICB2YXIgdHJhbnNpdGlvbk1hbmFnZXIgPSBjcmVhdGVUcmFuc2l0aW9uTWFuYWdlcigpOwoKICBmdW5jdGlvbiBzZXRTdGF0ZShuZXh0U3RhdGUpIHsKICAgICgwLCBfZXh0ZW5kczIuZGVmYXVsdCkoaGlzdG9yeSwgbmV4dFN0YXRlKTsKICAgIGhpc3RvcnkubGVuZ3RoID0gZ2xvYmFsSGlzdG9yeS5sZW5ndGg7CiAgICB0cmFuc2l0aW9uTWFuYWdlci5ub3RpZnlMaXN0ZW5lcnMoaGlzdG9yeS5sb2NhdGlvbiwgaGlzdG9yeS5hY3Rpb24pOwogIH0KCiAgdmFyIGZvcmNlTmV4dFBvcCA9IGZhbHNlOwogIHZhciBpZ25vcmVQYXRoID0gbnVsbDsKCiAgZnVuY3Rpb24gbG9jYXRpb25zQXJlRXF1YWwkJDEoYSwgYikgewogICAgcmV0dXJuIGEucGF0aG5hbWUgPT09IGIucGF0aG5hbWUgJiYgYS5zZWFyY2ggPT09IGIuc2VhcmNoICYmIGEuaGFzaCA9PT0gYi5oYXNoOwogIH0KCiAgZnVuY3Rpb24gaGFuZGxlSGFzaENoYW5nZSgpIHsKICAgIHZhciBwYXRoID0gZ2V0SGFzaFBhdGgoKTsKICAgIHZhciBlbmNvZGVkUGF0aCA9IGVuY29kZVBhdGgocGF0aCk7CgogICAgaWYgKHBhdGggIT09IGVuY29kZWRQYXRoKSB7CiAgICAgIC8vIEVuc3VyZSB3ZSBhbHdheXMgaGF2ZSBhIHByb3Blcmx5LWVuY29kZWQgaGFzaC4KICAgICAgcmVwbGFjZUhhc2hQYXRoKGVuY29kZWRQYXRoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBsb2NhdGlvbiA9IGdldERPTUxvY2F0aW9uKCk7CiAgICAgIHZhciBwcmV2TG9jYXRpb24gPSBoaXN0b3J5LmxvY2F0aW9uOwogICAgICBpZiAoIWZvcmNlTmV4dFBvcCAmJiBsb2NhdGlvbnNBcmVFcXVhbCQkMShwcmV2TG9jYXRpb24sIGxvY2F0aW9uKSkgcmV0dXJuOyAvLyBBIGhhc2hjaGFuZ2UgZG9lc24ndCBhbHdheXMgPT0gbG9jYXRpb24gY2hhbmdlLgoKICAgICAgaWYgKGlnbm9yZVBhdGggPT09IGNyZWF0ZVBhdGgobG9jYXRpb24pKSByZXR1cm47IC8vIElnbm9yZSB0aGlzIGNoYW5nZTsgd2UgYWxyZWFkeSBzZXRTdGF0ZSBpbiBwdXNoL3JlcGxhY2UuCgogICAgICBpZ25vcmVQYXRoID0gbnVsbDsKICAgICAgaGFuZGxlUG9wKGxvY2F0aW9uKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGhhbmRsZVBvcChsb2NhdGlvbikgewogICAgaWYgKGZvcmNlTmV4dFBvcCkgewogICAgICBmb3JjZU5leHRQb3AgPSBmYWxzZTsKICAgICAgc2V0U3RhdGUoKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBhY3Rpb24gPSAnUE9QJzsKICAgICAgdHJhbnNpdGlvbk1hbmFnZXIuY29uZmlybVRyYW5zaXRpb25Ubyhsb2NhdGlvbiwgYWN0aW9uLCBnZXRVc2VyQ29uZmlybWF0aW9uLCBmdW5jdGlvbiAob2spIHsKICAgICAgICBpZiAob2spIHsKICAgICAgICAgIHNldFN0YXRlKHsKICAgICAgICAgICAgYWN0aW9uOiBhY3Rpb24sCiAgICAgICAgICAgIGxvY2F0aW9uOiBsb2NhdGlvbgogICAgICAgICAgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldmVydFBvcChsb2NhdGlvbik7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJldmVydFBvcChmcm9tTG9jYXRpb24pIHsKICAgIHZhciB0b0xvY2F0aW9uID0gaGlzdG9yeS5sb2NhdGlvbjsgLy8gVE9ETzogV2UgY291bGQgcHJvYmFibHkgbWFrZSB0aGlzIG1vcmUgcmVsaWFibGUgYnkKICAgIC8vIGtlZXBpbmcgYSBsaXN0IG9mIHBhdGhzIHdlJ3ZlIHNlZW4gaW4gc2Vzc2lvblN0b3JhZ2UuCiAgICAvLyBJbnN0ZWFkLCB3ZSBqdXN0IGRlZmF1bHQgdG8gMCBmb3IgcGF0aHMgd2UgZG9uJ3Qga25vdy4KCiAgICB2YXIgdG9JbmRleCA9IGFsbFBhdGhzLmxhc3RJbmRleE9mKGNyZWF0ZVBhdGgodG9Mb2NhdGlvbikpOwogICAgaWYgKHRvSW5kZXggPT09IC0xKSB0b0luZGV4ID0gMDsKICAgIHZhciBmcm9tSW5kZXggPSBhbGxQYXRocy5sYXN0SW5kZXhPZihjcmVhdGVQYXRoKGZyb21Mb2NhdGlvbikpOwogICAgaWYgKGZyb21JbmRleCA9PT0gLTEpIGZyb21JbmRleCA9IDA7CiAgICB2YXIgZGVsdGEgPSB0b0luZGV4IC0gZnJvbUluZGV4OwoKICAgIGlmIChkZWx0YSkgewogICAgICBmb3JjZU5leHRQb3AgPSB0cnVlOwogICAgICBnbyhkZWx0YSk7CiAgICB9CiAgfSAvLyBFbnN1cmUgdGhlIGhhc2ggaXMgZW5jb2RlZCBwcm9wZXJseSBiZWZvcmUgZG9pbmcgYW55dGhpbmcgZWxzZS4KCgogIHZhciBwYXRoID0gZ2V0SGFzaFBhdGgoKTsKICB2YXIgZW5jb2RlZFBhdGggPSBlbmNvZGVQYXRoKHBhdGgpOwogIGlmIChwYXRoICE9PSBlbmNvZGVkUGF0aCkgcmVwbGFjZUhhc2hQYXRoKGVuY29kZWRQYXRoKTsKICB2YXIgaW5pdGlhbExvY2F0aW9uID0gZ2V0RE9NTG9jYXRpb24oKTsKICB2YXIgYWxsUGF0aHMgPSBbY3JlYXRlUGF0aChpbml0aWFsTG9jYXRpb24pXTsgLy8gUHVibGljIGludGVyZmFjZQoKICBmdW5jdGlvbiBjcmVhdGVIcmVmKGxvY2F0aW9uKSB7CiAgICB2YXIgYmFzZVRhZyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2Jhc2UnKTsKICAgIHZhciBocmVmID0gJyc7CgogICAgaWYgKGJhc2VUYWcgJiYgYmFzZVRhZy5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSkgewogICAgICBocmVmID0gc3RyaXBIYXNoKHdpbmRvdy5sb2NhdGlvbi5ocmVmKTsKICAgIH0KCiAgICByZXR1cm4gaHJlZiArICcjJyArIGVuY29kZVBhdGgoYmFzZW5hbWUgKyBjcmVhdGVQYXRoKGxvY2F0aW9uKSk7CiAgfQoKICBmdW5jdGlvbiBwdXNoKHBhdGgsIHN0YXRlKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gInByb2R1Y3Rpb24iID8gKDAsIF90aW55V2FybmluZy5kZWZhdWx0KShzdGF0ZSA9PT0gdW5kZWZpbmVkLCAnSGFzaCBoaXN0b3J5IGNhbm5vdCBwdXNoIHN0YXRlOyBpdCBpcyBpZ25vcmVkJykgOiB2b2lkIDA7CiAgICB2YXIgYWN0aW9uID0gJ1BVU0gnOwogICAgdmFyIGxvY2F0aW9uID0gY3JlYXRlTG9jYXRpb24ocGF0aCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGhpc3RvcnkubG9jYXRpb24pOwogICAgdHJhbnNpdGlvbk1hbmFnZXIuY29uZmlybVRyYW5zaXRpb25Ubyhsb2NhdGlvbiwgYWN0aW9uLCBnZXRVc2VyQ29uZmlybWF0aW9uLCBmdW5jdGlvbiAob2spIHsKICAgICAgaWYgKCFvaykgcmV0dXJuOwogICAgICB2YXIgcGF0aCA9IGNyZWF0ZVBhdGgobG9jYXRpb24pOwogICAgICB2YXIgZW5jb2RlZFBhdGggPSBlbmNvZGVQYXRoKGJhc2VuYW1lICsgcGF0aCk7CiAgICAgIHZhciBoYXNoQ2hhbmdlZCA9IGdldEhhc2hQYXRoKCkgIT09IGVuY29kZWRQYXRoOwoKICAgICAgaWYgKGhhc2hDaGFuZ2VkKSB7CiAgICAgICAgLy8gV2UgY2Fubm90IHRlbGwgaWYgYSBoYXNoY2hhbmdlIHdhcyBjYXVzZWQgYnkgYSBQVVNILCBzbyB3ZSdkCiAgICAgICAgLy8gcmF0aGVyIHNldFN0YXRlIGhlcmUgYW5kIGlnbm9yZSB0aGUgaGFzaGNoYW5nZS4gVGhlIGNhdmVhdCBoZXJlCiAgICAgICAgLy8gaXMgdGhhdCBvdGhlciBoYXNoIGhpc3RvcmllcyBpbiB0aGUgcGFnZSB3aWxsIGNvbnNpZGVyIGl0IGEgUE9QLgogICAgICAgIGlnbm9yZVBhdGggPSBwYXRoOwogICAgICAgIHB1c2hIYXNoUGF0aChlbmNvZGVkUGF0aCk7CiAgICAgICAgdmFyIHByZXZJbmRleCA9IGFsbFBhdGhzLmxhc3RJbmRleE9mKGNyZWF0ZVBhdGgoaGlzdG9yeS5sb2NhdGlvbikpOwogICAgICAgIHZhciBuZXh0UGF0aHMgPSBhbGxQYXRocy5zbGljZSgwLCBwcmV2SW5kZXggKyAxKTsKICAgICAgICBuZXh0UGF0aHMucHVzaChwYXRoKTsKICAgICAgICBhbGxQYXRocyA9IG5leHRQYXRoczsKICAgICAgICBzZXRTdGF0ZSh7CiAgICAgICAgICBhY3Rpb246IGFjdGlvbiwKICAgICAgICAgIGxvY2F0aW9uOiBsb2NhdGlvbgogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAicHJvZHVjdGlvbiIgPyAoMCwgX3RpbnlXYXJuaW5nLmRlZmF1bHQpKGZhbHNlLCAnSGFzaCBoaXN0b3J5IGNhbm5vdCBQVVNIIHRoZSBzYW1lIHBhdGg7IGEgbmV3IGVudHJ5IHdpbGwgbm90IGJlIGFkZGVkIHRvIHRoZSBoaXN0b3J5IHN0YWNrJykgOiB2b2lkIDA7CiAgICAgICAgc2V0U3RhdGUoKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiByZXBsYWNlKHBhdGgsIHN0YXRlKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gInByb2R1Y3Rpb24iID8gKDAsIF90aW55V2FybmluZy5kZWZhdWx0KShzdGF0ZSA9PT0gdW5kZWZpbmVkLCAnSGFzaCBoaXN0b3J5IGNhbm5vdCByZXBsYWNlIHN0YXRlOyBpdCBpcyBpZ25vcmVkJykgOiB2b2lkIDA7CiAgICB2YXIgYWN0aW9uID0gJ1JFUExBQ0UnOwogICAgdmFyIGxvY2F0aW9uID0gY3JlYXRlTG9jYXRpb24ocGF0aCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGhpc3RvcnkubG9jYXRpb24pOwogICAgdHJhbnNpdGlvbk1hbmFnZXIuY29uZmlybVRyYW5zaXRpb25Ubyhsb2NhdGlvbiwgYWN0aW9uLCBnZXRVc2VyQ29uZmlybWF0aW9uLCBmdW5jdGlvbiAob2spIHsKICAgICAgaWYgKCFvaykgcmV0dXJuOwogICAgICB2YXIgcGF0aCA9IGNyZWF0ZVBhdGgobG9jYXRpb24pOwogICAgICB2YXIgZW5jb2RlZFBhdGggPSBlbmNvZGVQYXRoKGJhc2VuYW1lICsgcGF0aCk7CiAgICAgIHZhciBoYXNoQ2hhbmdlZCA9IGdldEhhc2hQYXRoKCkgIT09IGVuY29kZWRQYXRoOwoKICAgICAgaWYgKGhhc2hDaGFuZ2VkKSB7CiAgICAgICAgLy8gV2UgY2Fubm90IHRlbGwgaWYgYSBoYXNoY2hhbmdlIHdhcyBjYXVzZWQgYnkgYSBSRVBMQUNFLCBzbyB3ZSdkCiAgICAgICAgLy8gcmF0aGVyIHNldFN0YXRlIGhlcmUgYW5kIGlnbm9yZSB0aGUgaGFzaGNoYW5nZS4gVGhlIGNhdmVhdCBoZXJlCiAgICAgICAgLy8gaXMgdGhhdCBvdGhlciBoYXNoIGhpc3RvcmllcyBpbiB0aGUgcGFnZSB3aWxsIGNvbnNpZGVyIGl0IGEgUE9QLgogICAgICAgIGlnbm9yZVBhdGggPSBwYXRoOwogICAgICAgIHJlcGxhY2VIYXNoUGF0aChlbmNvZGVkUGF0aCk7CiAgICAgIH0KCiAgICAgIHZhciBwcmV2SW5kZXggPSBhbGxQYXRocy5pbmRleE9mKGNyZWF0ZVBhdGgoaGlzdG9yeS5sb2NhdGlvbikpOwogICAgICBpZiAocHJldkluZGV4ICE9PSAtMSkgYWxsUGF0aHNbcHJldkluZGV4XSA9IHBhdGg7CiAgICAgIHNldFN0YXRlKHsKICAgICAgICBhY3Rpb246IGFjdGlvbiwKICAgICAgICBsb2NhdGlvbjogbG9jYXRpb24KICAgICAgfSk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGdvKG4pIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAicHJvZHVjdGlvbiIgPyAoMCwgX3RpbnlXYXJuaW5nLmRlZmF1bHQpKGNhbkdvV2l0aG91dFJlbG9hZCwgJ0hhc2ggaGlzdG9yeSBnbyhuKSBjYXVzZXMgYSBmdWxsIHBhZ2UgcmVsb2FkIGluIHRoaXMgYnJvd3NlcicpIDogdm9pZCAwOwogICAgZ2xvYmFsSGlzdG9yeS5nbyhuKTsKICB9CgogIGZ1bmN0aW9uIGdvQmFjaygpIHsKICAgIGdvKC0xKTsKICB9CgogIGZ1bmN0aW9uIGdvRm9yd2FyZCgpIHsKICAgIGdvKDEpOwogIH0KCiAgdmFyIGxpc3RlbmVyQ291bnQgPSAwOwoKICBmdW5jdGlvbiBjaGVja0RPTUxpc3RlbmVycyhkZWx0YSkgewogICAgbGlzdGVuZXJDb3VudCArPSBkZWx0YTsKCiAgICBpZiAobGlzdGVuZXJDb3VudCA9PT0gMSAmJiBkZWx0YSA9PT0gMSkgewogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihIYXNoQ2hhbmdlRXZlbnQkMSwgaGFuZGxlSGFzaENoYW5nZSk7CiAgICB9IGVsc2UgaWYgKGxpc3RlbmVyQ291bnQgPT09IDApIHsKICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoSGFzaENoYW5nZUV2ZW50JDEsIGhhbmRsZUhhc2hDaGFuZ2UpOwogICAgfQogIH0KCiAgdmFyIGlzQmxvY2tlZCA9IGZhbHNlOwoKICBmdW5jdGlvbiBibG9jayhwcm9tcHQpIHsKICAgIGlmIChwcm9tcHQgPT09IHZvaWQgMCkgewogICAgICBwcm9tcHQgPSBmYWxzZTsKICAgIH0KCiAgICB2YXIgdW5ibG9jayA9IHRyYW5zaXRpb25NYW5hZ2VyLnNldFByb21wdChwcm9tcHQpOwoKICAgIGlmICghaXNCbG9ja2VkKSB7CiAgICAgIGNoZWNrRE9NTGlzdGVuZXJzKDEpOwogICAgICBpc0Jsb2NrZWQgPSB0cnVlOwogICAgfQoKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChpc0Jsb2NrZWQpIHsKICAgICAgICBpc0Jsb2NrZWQgPSBmYWxzZTsKICAgICAgICBjaGVja0RPTUxpc3RlbmVycygtMSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB1bmJsb2NrKCk7CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gbGlzdGVuKGxpc3RlbmVyKSB7CiAgICB2YXIgdW5saXN0ZW4gPSB0cmFuc2l0aW9uTWFuYWdlci5hcHBlbmRMaXN0ZW5lcihsaXN0ZW5lcik7CiAgICBjaGVja0RPTUxpc3RlbmVycygxKTsKICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgIGNoZWNrRE9NTGlzdGVuZXJzKC0xKTsKICAgICAgdW5saXN0ZW4oKTsKICAgIH07CiAgfQoKICB2YXIgaGlzdG9yeSA9IHsKICAgIGxlbmd0aDogZ2xvYmFsSGlzdG9yeS5sZW5ndGgsCiAgICBhY3Rpb246ICdQT1AnLAogICAgbG9jYXRpb246IGluaXRpYWxMb2NhdGlvbiwKICAgIGNyZWF0ZUhyZWY6IGNyZWF0ZUhyZWYsCiAgICBwdXNoOiBwdXNoLAogICAgcmVwbGFjZTogcmVwbGFjZSwKICAgIGdvOiBnbywKICAgIGdvQmFjazogZ29CYWNrLAogICAgZ29Gb3J3YXJkOiBnb0ZvcndhcmQsCiAgICBibG9jazogYmxvY2ssCiAgICBsaXN0ZW46IGxpc3RlbgogIH07CiAgcmV0dXJuIGhpc3Rvcnk7Cn0KCmZ1bmN0aW9uIGNsYW1wKG4sIGxvd2VyQm91bmQsIHVwcGVyQm91bmQpIHsKICByZXR1cm4gTWF0aC5taW4oTWF0aC5tYXgobiwgbG93ZXJCb3VuZCksIHVwcGVyQm91bmQpOwp9Ci8qKgogKiBDcmVhdGVzIGEgaGlzdG9yeSBvYmplY3QgdGhhdCBzdG9yZXMgbG9jYXRpb25zIGluIG1lbW9yeS4KICovCgoKZnVuY3Rpb24gY3JlYXRlTWVtb3J5SGlzdG9yeShwcm9wcykgewogIGlmIChwcm9wcyA9PT0gdm9pZCAwKSB7CiAgICBwcm9wcyA9IHt9OwogIH0KCiAgdmFyIF9wcm9wcyA9IHByb3BzLAogICAgICBnZXRVc2VyQ29uZmlybWF0aW9uID0gX3Byb3BzLmdldFVzZXJDb25maXJtYXRpb24sCiAgICAgIF9wcm9wcyRpbml0aWFsRW50cmllcyA9IF9wcm9wcy5pbml0aWFsRW50cmllcywKICAgICAgaW5pdGlhbEVudHJpZXMgPSBfcHJvcHMkaW5pdGlhbEVudHJpZXMgPT09IHZvaWQgMCA/IFsnLyddIDogX3Byb3BzJGluaXRpYWxFbnRyaWVzLAogICAgICBfcHJvcHMkaW5pdGlhbEluZGV4ID0gX3Byb3BzLmluaXRpYWxJbmRleCwKICAgICAgaW5pdGlhbEluZGV4ID0gX3Byb3BzJGluaXRpYWxJbmRleCA9PT0gdm9pZCAwID8gMCA6IF9wcm9wcyRpbml0aWFsSW5kZXgsCiAgICAgIF9wcm9wcyRrZXlMZW5ndGggPSBfcHJvcHMua2V5TGVuZ3RoLAogICAgICBrZXlMZW5ndGggPSBfcHJvcHMka2V5TGVuZ3RoID09PSB2b2lkIDAgPyA2IDogX3Byb3BzJGtleUxlbmd0aDsKICB2YXIgdHJhbnNpdGlvbk1hbmFnZXIgPSBjcmVhdGVUcmFuc2l0aW9uTWFuYWdlcigpOwoKICBmdW5jdGlvbiBzZXRTdGF0ZShuZXh0U3RhdGUpIHsKICAgICgwLCBfZXh0ZW5kczIuZGVmYXVsdCkoaGlzdG9yeSwgbmV4dFN0YXRlKTsKICAgIGhpc3RvcnkubGVuZ3RoID0gaGlzdG9yeS5lbnRyaWVzLmxlbmd0aDsKICAgIHRyYW5zaXRpb25NYW5hZ2VyLm5vdGlmeUxpc3RlbmVycyhoaXN0b3J5LmxvY2F0aW9uLCBoaXN0b3J5LmFjdGlvbik7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVLZXkoKSB7CiAgICByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIGtleUxlbmd0aCk7CiAgfQoKICB2YXIgaW5kZXggPSBjbGFtcChpbml0aWFsSW5kZXgsIDAsIGluaXRpYWxFbnRyaWVzLmxlbmd0aCAtIDEpOwogIHZhciBlbnRyaWVzID0gaW5pdGlhbEVudHJpZXMubWFwKGZ1bmN0aW9uIChlbnRyeSkgewogICAgcmV0dXJuIHR5cGVvZiBlbnRyeSA9PT0gJ3N0cmluZycgPyBjcmVhdGVMb2NhdGlvbihlbnRyeSwgdW5kZWZpbmVkLCBjcmVhdGVLZXkoKSkgOiBjcmVhdGVMb2NhdGlvbihlbnRyeSwgdW5kZWZpbmVkLCBlbnRyeS5rZXkgfHwgY3JlYXRlS2V5KCkpOwogIH0pOyAvLyBQdWJsaWMgaW50ZXJmYWNlCgogIHZhciBjcmVhdGVIcmVmID0gY3JlYXRlUGF0aDsKCiAgZnVuY3Rpb24gcHVzaChwYXRoLCBzdGF0ZSkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICJwcm9kdWN0aW9uIiA/ICgwLCBfdGlueVdhcm5pbmcuZGVmYXVsdCkoIShfdHlwZW9mKHBhdGgpID09PSAnb2JqZWN0JyAmJiBwYXRoLnN0YXRlICE9PSB1bmRlZmluZWQgJiYgc3RhdGUgIT09IHVuZGVmaW5lZCksICdZb3Ugc2hvdWxkIGF2b2lkIHByb3ZpZGluZyBhIDJuZCBzdGF0ZSBhcmd1bWVudCB0byBwdXNoIHdoZW4gdGhlIDFzdCAnICsgJ2FyZ3VtZW50IGlzIGEgbG9jYXRpb24tbGlrZSBvYmplY3QgdGhhdCBhbHJlYWR5IGhhcyBzdGF0ZTsgaXQgaXMgaWdub3JlZCcpIDogdm9pZCAwOwogICAgdmFyIGFjdGlvbiA9ICdQVVNIJzsKICAgIHZhciBsb2NhdGlvbiA9IGNyZWF0ZUxvY2F0aW9uKHBhdGgsIHN0YXRlLCBjcmVhdGVLZXkoKSwgaGlzdG9yeS5sb2NhdGlvbik7CiAgICB0cmFuc2l0aW9uTWFuYWdlci5jb25maXJtVHJhbnNpdGlvblRvKGxvY2F0aW9uLCBhY3Rpb24sIGdldFVzZXJDb25maXJtYXRpb24sIGZ1bmN0aW9uIChvaykgewogICAgICBpZiAoIW9rKSByZXR1cm47CiAgICAgIHZhciBwcmV2SW5kZXggPSBoaXN0b3J5LmluZGV4OwogICAgICB2YXIgbmV4dEluZGV4ID0gcHJldkluZGV4ICsgMTsKICAgICAgdmFyIG5leHRFbnRyaWVzID0gaGlzdG9yeS5lbnRyaWVzLnNsaWNlKDApOwoKICAgICAgaWYgKG5leHRFbnRyaWVzLmxlbmd0aCA+IG5leHRJbmRleCkgewogICAgICAgIG5leHRFbnRyaWVzLnNwbGljZShuZXh0SW5kZXgsIG5leHRFbnRyaWVzLmxlbmd0aCAtIG5leHRJbmRleCwgbG9jYXRpb24pOwogICAgICB9IGVsc2UgewogICAgICAgIG5leHRFbnRyaWVzLnB1c2gobG9jYXRpb24pOwogICAgICB9CgogICAgICBzZXRTdGF0ZSh7CiAgICAgICAgYWN0aW9uOiBhY3Rpb24sCiAgICAgICAgbG9jYXRpb246IGxvY2F0aW9uLAogICAgICAgIGluZGV4OiBuZXh0SW5kZXgsCiAgICAgICAgZW50cmllczogbmV4dEVudHJpZXMKICAgICAgfSk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHJlcGxhY2UocGF0aCwgc3RhdGUpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAicHJvZHVjdGlvbiIgPyAoMCwgX3RpbnlXYXJuaW5nLmRlZmF1bHQpKCEoX3R5cGVvZihwYXRoKSA9PT0gJ29iamVjdCcgJiYgcGF0aC5zdGF0ZSAhPT0gdW5kZWZpbmVkICYmIHN0YXRlICE9PSB1bmRlZmluZWQpLCAnWW91IHNob3VsZCBhdm9pZCBwcm92aWRpbmcgYSAybmQgc3RhdGUgYXJndW1lbnQgdG8gcmVwbGFjZSB3aGVuIHRoZSAxc3QgJyArICdhcmd1bWVudCBpcyBhIGxvY2F0aW9uLWxpa2Ugb2JqZWN0IHRoYXQgYWxyZWFkeSBoYXMgc3RhdGU7IGl0IGlzIGlnbm9yZWQnKSA6IHZvaWQgMDsKICAgIHZhciBhY3Rpb24gPSAnUkVQTEFDRSc7CiAgICB2YXIgbG9jYXRpb24gPSBjcmVhdGVMb2NhdGlvbihwYXRoLCBzdGF0ZSwgY3JlYXRlS2V5KCksIGhpc3RvcnkubG9jYXRpb24pOwogICAgdHJhbnNpdGlvbk1hbmFnZXIuY29uZmlybVRyYW5zaXRpb25Ubyhsb2NhdGlvbiwgYWN0aW9uLCBnZXRVc2VyQ29uZmlybWF0aW9uLCBmdW5jdGlvbiAob2spIHsKICAgICAgaWYgKCFvaykgcmV0dXJuOwogICAgICBoaXN0b3J5LmVudHJpZXNbaGlzdG9yeS5pbmRleF0gPSBsb2NhdGlvbjsKICAgICAgc2V0U3RhdGUoewogICAgICAgIGFjdGlvbjogYWN0aW9uLAogICAgICAgIGxvY2F0aW9uOiBsb2NhdGlvbgogICAgICB9KTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gZ28obikgewogICAgdmFyIG5leHRJbmRleCA9IGNsYW1wKGhpc3RvcnkuaW5kZXggKyBuLCAwLCBoaXN0b3J5LmVudHJpZXMubGVuZ3RoIC0gMSk7CiAgICB2YXIgYWN0aW9uID0gJ1BPUCc7CiAgICB2YXIgbG9jYXRpb24gPSBoaXN0b3J5LmVudHJpZXNbbmV4dEluZGV4XTsKICAgIHRyYW5zaXRpb25NYW5hZ2VyLmNvbmZpcm1UcmFuc2l0aW9uVG8obG9jYXRpb24sIGFjdGlvbiwgZ2V0VXNlckNvbmZpcm1hdGlvbiwgZnVuY3Rpb24gKG9rKSB7CiAgICAgIGlmIChvaykgewogICAgICAgIHNldFN0YXRlKHsKICAgICAgICAgIGFjdGlvbjogYWN0aW9uLAogICAgICAgICAgbG9jYXRpb246IGxvY2F0aW9uLAogICAgICAgICAgaW5kZXg6IG5leHRJbmRleAogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIE1pbWljIHRoZSBiZWhhdmlvciBvZiBET00gaGlzdG9yaWVzIGJ5CiAgICAgICAgLy8gY2F1c2luZyBhIHJlbmRlciBhZnRlciBhIGNhbmNlbGxlZCBQT1AuCiAgICAgICAgc2V0U3RhdGUoKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBnb0JhY2soKSB7CiAgICBnbygtMSk7CiAgfQoKICBmdW5jdGlvbiBnb0ZvcndhcmQoKSB7CiAgICBnbygxKTsKICB9CgogIGZ1bmN0aW9uIGNhbkdvKG4pIHsKICAgIHZhciBuZXh0SW5kZXggPSBoaXN0b3J5LmluZGV4ICsgbjsKICAgIHJldHVybiBuZXh0SW5kZXggPj0gMCAmJiBuZXh0SW5kZXggPCBoaXN0b3J5LmVudHJpZXMubGVuZ3RoOwogIH0KCiAgZnVuY3Rpb24gYmxvY2socHJvbXB0KSB7CiAgICBpZiAocHJvbXB0ID09PSB2b2lkIDApIHsKICAgICAgcHJvbXB0ID0gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRyYW5zaXRpb25NYW5hZ2VyLnNldFByb21wdChwcm9tcHQpOwogIH0KCiAgZnVuY3Rpb24gbGlzdGVuKGxpc3RlbmVyKSB7CiAgICByZXR1cm4gdHJhbnNpdGlvbk1hbmFnZXIuYXBwZW5kTGlzdGVuZXIobGlzdGVuZXIpOwogIH0KCiAgdmFyIGhpc3RvcnkgPSB7CiAgICBsZW5ndGg6IGVudHJpZXMubGVuZ3RoLAogICAgYWN0aW9uOiAnUE9QJywKICAgIGxvY2F0aW9uOiBlbnRyaWVzW2luZGV4XSwKICAgIGluZGV4OiBpbmRleCwKICAgIGVudHJpZXM6IGVudHJpZXMsCiAgICBjcmVhdGVIcmVmOiBjcmVhdGVIcmVmLAogICAgcHVzaDogcHVzaCwKICAgIHJlcGxhY2U6IHJlcGxhY2UsCiAgICBnbzogZ28sCiAgICBnb0JhY2s6IGdvQmFjaywKICAgIGdvRm9yd2FyZDogZ29Gb3J3YXJkLAogICAgY2FuR286IGNhbkdvLAogICAgYmxvY2s6IGJsb2NrLAogICAgbGlzdGVuOiBsaXN0ZW4KICB9OwogIHJldHVybiBoaXN0b3J5Owp9"},null]}